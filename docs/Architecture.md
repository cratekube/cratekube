Overview
========

This article proposes a target architecture for Crate's adoption of Kubernetes (k8s). Kubernetes is a container orchestration system that covers many of the same functions as a traditional system adminstrator. It has multiple, abstract components that can be used for managing application life cycle management through automation in a distributed architecture and is currently the most popular solution for running containers at scale.

The proposed architecture is meant to provide Kubernetes as a product, such that it can be adopted and managed by anyone as a turn-key solution. This will require that infrastructure is provided by third-party platforms and is accessible to automation through a robust set of provisioning APIs. The final product should yield long term cost saving benefits in the form of reduced licensing and operational costs.

Components
==========

The following architecture is compromised of multiple components. At a high level, a distinction can be drawn between the components that are provided as a part of Kubernetes and those that will be created by Crate to instantiate and manage Kubenernetes. For reference, both types of components are listed below.

Kubernetes
----------

### Control Plane

The control plane is a collection of four critical Kuberentes components that can be horizontally scaled.

#### kube-apiserver

The `kube-apiserver` provides an internal and external interface to Kubernetes. It serves the Kubernetes API, handles REST requests, and directly interfaces with `etcd` to watch and store cluster state.

#### kube-scheduler

The `kube-scheduler` indirectly watches `etcd` through the `API Server` for pods that are not assigned to a host. Once a pod is identified as needing a host, the `Scheduler` evaluates which host is best suited to run the pod and assigns the pod accordingly.

#### kube-controller-manager

The `kube-controller-manager` is responsible for managing Kubernetes controllers, such as `DaemonSet` or `ReplicationController`. It helps drive cluster state towards desired cluster state. A variant of this component exists specifically for third party vendors, the `cloud-controller-manager`. It provides similar functionality be geared specifically towards the target cloud, e.g., DigitalOcean, AWS, GKE, etc.

#### Etcd

`etcd` is a distributed key value store. It serves as the bedrock for a Kubernetes cluster by providing a single, distributed, location for cluster state.

### Node

A Kubernetes node contains components for interacting with the Kubernetes API and host networking.

#### Kubelet

The `kubelet` is responsible for watching the `API Server` for all pods that are assigned to the node it is running on. It monitors the state of the pod and directly manages containers running on the host.

#### Kube-Proxy

The `kube-proxy` provides IP networking to a pod. It provides simple round-robin load balancing and routes virtual IPs of Kubernetes services into IPs of backend Pods.

Crate
-----

### Platform

These services reflect the general creation and management of cloud infrastructure and Kubernetes. They are exposed to customers in varying degrees and provide value by abstracting platform operations. All services are expected to live outside the customer cluster unless otherwise specified. Services are expected to be initially deployed through a template in the AWS marketplace. This template will create a temporary cluster for bootstrapping everything, but if technically necessary, a singleton may be created to handle initial provisioning, e.g., using `kind` or a virtual appliance to create provision the components necessary to create the initially infrastructure and cluster.

#### Cloud Management Service

The `cloud-mgmt-service` will be in charge of provisioning and monitoring all cloud resources and services. Cloud resources are loosely defined as managed virtual infrastructure so as to include cluster created on-prem through Openstack or vSphere.

In AWS, this is expected to provision any and all resource necessary to create a Kubernetes cluster, including but not limited to IAM, VPC, EC2, etc. [Terraform ](https://www.terraform.io/)is expected to be used whenever viable.  Account access will be governed by which functions are implemented, end state will require root access. Terraform templates must provide enough customization for reconfiguring resources to better match compliances rules. State files generated by Terraform must be persisted for later use.

#### Cluster Management Service

The `cluster-mgmt-service` will provide everything needed for creating and monitoring a Kubernetes cluster and configuring it post-bootstrap. For direct cluster creation [RKE](https://rancher.com/docs/rke/latest/en/) is expected to be used. For hosted cluster creation, such as AKS, EKS, or GKE,  `cluster-mgmt-service` should invoke `cloud-mgmt-service`. State files generated by RKE must be persisted for later use.

#### Policy Management Service

The `policy-mgmt-service` will provide compliance validation for all infrastructure provisioned through platform services. It does not require access to the cloud provider since it only needs to check a desired configuration against a set of known rules. In this context, the service will behave similarly to a Kubernetes admission controller that only processes validation requests.

#### Lifecycle Service

The `lifecycle-service` will be the primary initiator of all platform services. It will track lifecycle of all platform components and handle service creation, update, and teardown. The service should be able to reconfigure itself as needed to be aware of newly created services. It will interact directly with the `cloud-mgmt-service` and the `cluster-mgmt-service` to create cloud resources and Kubernetes clusters.

### Add Ons

These services are available for use in any given Kubernetes cluster, primarly but not exclusively developed by Crate.

#### Docs

The `docs-service` and `docs-webui` will provide living documentation on how to use Crate. Eventually, it will provide detailed information and where possible an interactive terminal for users to try features.

#### Automounts

The `automounts-service` service will provide pods access to legacy EngIT NFS storage. It is expected to be available only to on-prem clusters, however, depending on cost and security, there may be a way to expose on-prem data in AWS. The solution may be implented through `autofs`, however, this is an implementation that should be considered at time of design.

MVP
===

MVP should allow for the following:

-   K8s Cluster Provisioning
-   Alignment with Leadership
    -   Public Cloud
    -   No-Ops
-   Policy Management
-   Focus on New Users
-   Docs
-   Legacy IT storage Access

To that end, MVP should have the ability to instantiate a Kubernetes cluster in AWS using RKE and EC2 instances. All platform services will need to be created. These services should be bootstrapped via a template in the AWS marketplace, culminating in the `lifecycle-service` creating all platform components and consequently all customer infrastructure and cluster components.

Infrastructure should be created in accordance with Cisco Infosec guidelines and validated using the `policy-mgmt-service`. Clusters are not expected to be created with `PodSecurityPolicy`  or custom RBAC.

# Diagrams

## Component
![Component](http://www.plantuml.com/plantuml/svg/dPDFIyCm6CRl_HGlyrnMBp9wa66b5_yW3hsK7RBqRGbDav6aao5-TzEbQjQLKCmb6tduFM-U9rrhGvJfMXw1Mtj26r8ZB5uaP_G8JqJOloqA0njK1qPnOLMV4NYhs9-qSLkt9jPEjGMuIf8yJv9VwTU5HyPbLqvP-0O5xLKZUC-sorCvba8jEqLHRoFFTMJxZEP3gWOsHYfIdxj18TnfhDtf09ecFR8AwP5od9mS2lvpxasUvtStsNM8cl5E6rJ1O5moJZZEfi9ojGiwF7GxL08DQXZCHkHc5Gzm__xkPwYNEBwzh09Ie0g9TLkMoB7VcJZ81lKyuFJxIk6TS5RsM62YKcGcRDmlfAU7WDfk5cOfeG8TP3hw7fMzljtFHjW9_m-Ol4bsdhCF6iqS3cMSIHWJBEgl9yYag5Wzb-O_mdJu69Qj5CnE5grHb5tBlm40)
<details><summary>Show UML Code</summary>
<p>

```
@startuml
       package "Policy Management Service"   {
            [policy-mgmt-service]  #00FF00
        }
       package "Cloud Management Service" {
         [cloud-mgmt-service] #00FFFF
         [Cloud resources]
       }
        package "Network Storage" {
          [network-storage]
        }
        package "Lifecycle Service" {
          [lifecycle-service] #FFB6C1
        }
        package "Cluster Management Service" {
          [cluster-mgmt-service] #fed8b1
        }
        package "Kubernetes Cluster" {
          [k8-cluster]
        }

            [cloud-mgmt-service] --> [Cloud resources] : creates/deletes/invokes
            [cloud-mgmt-service] --> [policy-mgmt-service] : Validates infra
            [cloud-mgmt-service] --> [network-storage] : Stores State
            [lifecycle-service] -->  [cluster-mgmt-service] : CRUD
            [lifecycle-service] -->  [cloud-mgmt-service] : CRUD
            [lifecycle-service] -->  [network-storage] : Creates/deletes
            [cluster-mgmt-service] --> [network-storage]: Stores State
            [cluster-mgmt-service] --> [policy-mgmt-service]: Validate Config
            [cluster-mgmt-service] --> [k8-cluster]: Manage/monitor
@enduml
```
</p>
</details>

## Logical
![Component](http://www.plantuml.com/plantuml/svg/hLN1ZjCm4BttAwnoZbeue5KFQ27GoqAreW8ErHwyzgHOTUneREzgXVBls4qwwjOX6m6-HDMyl7dptiIzTfwZ3xMU2Ms3PFDFvPiv-pLZyHWhWSrlhXoxrTnN5cjMwk0yu0aHJyF5WUyZxjPg9PxO5sxYpngCPrl01oM0mFtPDKTaKUzhNxWESyTUBPVhzN99o9Pb7SgayAK6k-CS0-JndA4wBWHd0mfmTwTIInXgkm7_QF70jjuYtr-CipDTjN1TbOY6c3wh2iIJq31ipKwVwcVAr-iFRylNOwnz9YywlnCTyDAR2kJLVTvXnCwYU9Sxo5PC870FRY51Gtegys0FuAOH3g_5YdtdMib4ovIfa4yZosA9H2a_SF4HoOWbzvr8SiT8K_drsySf5AJm7mW69YcV-qn4UShZfkIUv3GJWwASW9NML6e_cUqct0EQDCVfTebatIulQckKjtZYcj5-qkMKlVnivmaNDNcqEbra1jZ6IhZ4qGVLaRvlLFg8ShvkdaE45BnHXJk2-b702vdoGU1oyOZgtDFsg7-a8-irQlgKnteB0XTr0fE6JDcAAUC1AoxEDwKTrx8LFq46FIh1THZ-jvtRWPn-M3m03WL4IMBQiGslmJM9U2H7QOKhWfgFrljb_2E81szh6upFeTaCirnjSF5rm6c22SsRPlv_GPdvlU9sTWr6fl__tm00)
<details><summary>Show UML Code</summary>
<p>

```
@startuml
cloud "EC2" {
    node "K8s Platform Cluster" {
       package "Policy Management Service" {
            [policy-mgmt-service] #00FF00
        } 
       package "Cloud Management Service" {
         [cloud-mgmt-service] #00FFFF
         [Cloud resources]
       }
        package "Network Storage" {
          [network-storage]
        }
        package "Lifecycle Service" {
          [lifecycle-service] #FFB6C1
        }
        package "Cluster Management Service" {
          [cluster-mgmt-service] #fed8b1
        }
            [cloud-mgmt-service] --> [Cloud resources] : creates/deletes/invokes
            [cloud-mgmt-service] --> [policy-mgmt-service] : Validates infra
            [cloud-mgmt-service] --> [network-storage] : Stores State
            [lifecycle-service] -->  [cluster-mgmt-service] : CRUD
            [lifecycle-service] -->  [cloud-mgmt-service] : CRUD
            [lifecycle-service] -->  [network-storage] : Creates/deletes
            [cluster-mgmt-service] --> [network-storage]: Stores State
            [cluster-mgmt-service] --> [policy-mgmt-service]: Validate Config
            [cluster-mgmt-service] --> [Kubernetes Cluster]: Manage/monitor
       
    }
     node "Kubernetes Cluster" {
            node "Control Plane Node" {
              package "KubeApiServer" {
                 [kube-api-server] --> [etcd] : read/write
         }   
               package "Kube Controller Manager" {
                 [kube-controller-manager] --> [kube-api-server] : interfaces
         }
               package "Kube Scheduler" {
                 [kube-schedular] --> [kube-api-server] : interfaces
         }
       }
            node "Worker Node" {
             node "Crate Namespaces" {
              package "docs-ui"
              package "docs-service"
              package "automounts-service"
          }
            
           node "Customer Namespaces" {
              package "Customer app"
              package "Customer app"
              package "Customer app"
          }
       }      
}
@enduml


```
</p>
</details>

## Physical
![Component](http://www.plantuml.com/plantuml/svg/VPEnQiCm48PtFSMXpWQtG-cOr3HG0cqWGsP5kgGciYHEKcWeUVSwDi5rELkhl_lkln-yY4bHoeqLslfiGBvLJn9-1FJFUOCWFmEIIhLt4IgROqBgaE45fK_gs9ATf6YEJIeYqhdMAE6XB5Vju_bUzt_YWEPb_yXE16zhVU5Mb2KxOEi3weks-0TVhLwVgy5_XV6zx-v02ZRapxL1YbF7BdTRAUwAiM6TzqWE4_ADzL3bNI9lOMELG_Zm1dk8MNLgVR3LNsYoRLtJKA5xgRsLgfmwpjCgrBTM9Y5CsipCMqnpza3--oA5O2kgI2M4dQSJqd0yerepYzWzt7VTRL765Dv5EKvo3v9ZyWqIbsLi6z1b25BCbp8N5Q0hPGXp3mOWhcA1pjp-o5y0)
<details><summary>Show UML Code</summary>
<p>

```
@startuml
cloud "EC2" {
       node "Operations Cluster" {
           package "cloud-mgmt-service" #00FFFF
           package "cluster-mgmt-service" #fed8b1
           package "policy-mgmt-service" #00FF00
           package "lifecycle-service" #FFB6C1
        } 
       node "Infra Providers" {
           package "AWS"
       }
       node "Kubernetes Cluster" {
         node "Control Plane Node" {
            package "kube Scheduler"
            package "kube-controller-manager"
            package "kube-apiserver"
            package "etcd"
            package "kubelet"
            package "kube-proxy"

      }
       node "Crate Worker Node" {
           package "Kubelet"
           package "kube-proxy"
           package "crate add-ons"
      }
      node "Customer Worker Node" {
          package "Customer App"
          package "kubelet"
          package "kube-proxy"  

        }
   
      }  
}
@enduml

```
</p>
</details>

## Security

![Component](http://www.plantuml.com/plantuml/svg/ZP9VQy8m5CNV-oc2UoxKbo5zA39166v3s6Cc4fDRpKoJaZ-A4x_xObt0RDCcRpSv-N4uvuwD9TgwHcHICK23sSYWkI2sLhf14-6C1Jr0nmoXbj0jMNl9H2Z7q2kHVcf0MlGEUiSfT39_C3qBycRTsDnSdZxayNDlbyJPpTTfWHwAOkgFLv-kmI-y1dgW0duJ4HRXwHPnEdrwd0op977kshpgTLdYCD15verU1z35SZi2J2-AkndKm4QhOKoUAy7fuGwuxGIzsHP5p7sMjIPehjMEiz0dvkVBlFsvz1ZIye29ly_S2hG42oPQ2VpttbEiCFzJtXI3opzZDiij76ekeDEaTCRKNkPL76rASVth6DWXt5HolvUmQ-daTC_L_G9B78PqgrL_eoK-3-sMfqFZkijkwW2dR0oIkKPy0m00)
<details><summary>Show UML Code</summary>
<p>

```
@startuml
node "K8s Platform Cluster" {
  package "Cloud Management Service" {
    [cloud-mgmt-service\n{jwt_authz}] #00FFFF
  }
  package "Lifecycle Service" {
     [lifecycle-service\n{jwt_authz}] #FFB6C1
    [lifecycle-service\n{jwt_authz}] -up->[cloud-mgmt-service\n{jwt_authz}]:[jwt_authc]
 }
 package "Cluster Management Service" {
   [cluster-mgmt-service\n{jwt_authz}] #fed8b1
 }
 package "Policy Management Service" {
   [policy-mgmt-service\n{jwt_authz}] #00FF00
 }
 package "Infra Provider" {
  [infra-provider\n{api_authz}]
 }
 package "Kubernetes Cluster" {
 [Kubernetes Cluster\n{tls_authz}]
 }
 package "Node" {
 [ssh_keyfile]
 }
  [lifecycle-service\n{jwt_authz}] -down-> [cluster-mgmt-service\n{jwt_authz}]:[jwt_authc]
  [cloud-mgmt-service\n{jwt_authz}] -down->[policy-mgmt-service\n{jwt_authz}]:[jwt_authc]
  [cluster-mgmt-service\n{jwt_authz}] -up->[policy-mgmt-service\n{jwt_authz}]:[jwt_authc]
  [cloud-mgmt-service\n{jwt_authz}] -> [infra-provider\n{api_authz}]:[api_authc]
  [cluster-mgmt-service\n{jwt_authz}] -> [Kubernetes Cluster\n{tls_authz}]:[tls_pki]
  [cluster-mgmt-service\n{jwt_authz}] -> [ssh_keyfile]:[ssh_pki]
}
@enduml
```
</p>
</details>
