# Overview

This document proposes a target architecture for the [MVaP state](https://www.toptal.com/designers/product-design/minimum-valuable-product) of a Kubernetes-based platform called CrateKube. CrateKube adds many features and value-added services to simplify the management of the Kubernetes orchestrator. Kubernetes makes it easy to manage containers, and CrateKube makes it easy to manage Kubernetes.

This architecture proposal is meant to provide a turn-key solution that can be adopted by anyone interested in running containers on a Kubernetes platform. This will require that infrastructure is provided by third-party platforms and is accessible to automation through a robust set of provisioning APIs. The final product should yield long term cost saving benefits in the form of reduced licensing and operational costs.

# Components

The following architecture is comprised of multiple components. At a high level, a distinction can be drawn between the components that are provided as a part of Kubernetes and those that will be created by the CrateKube team to instantiate and manage Kubernetes. For reference, both types of components are listed below.

## Kubernetes Components

### Control Plane

The control plane is a collection of four critical Kubernetes components that can be horizontally scaled.

#### kube-apiserver

The `kube-apiserver` (referred to as the `API Server` in this document) provides an internal and external interface to Kubernetes. It serves the Kubernetes API, handles REST requests, and directly interfaces with `etcd` to watch and store cluster state.

#### kube-scheduler

The `kube-scheduler` indirectly watches `etcd` through the `API Server` for pods that are not assigned to a host. Once a pod is identified as needing a host, the `Scheduler` evaluates which host is best suited to run the pod and assigns the pod accordingly.

#### kube-controller-manager

The `kube-controller-manager` is responsible for managing Kubernetes controllers, such as `DaemonSet` or `ReplicationController`. It helps drive cluster state towards desired cluster state. A variant of this component exists specifically for third party vendors, the `cloud-controller-manager`. It provides similar functionality geared specifically towards the target cloud, e.g., DigitalOcean, AWS, GKE, etc.

#### Etcd

`etcd` is a distributed key value store. It serves as the bedrock for a Kubernetes cluster by providing a single, distributed, location for cluster state.

### Node

A Kubernetes node is a generic term for a set of resources that provide the ability to interact with the Kubernetes API and host networking. In the CrateKube system, nodes are backed by infrastructure by third-party vendors such as AWS, GKE, etc.

#### Kubelet

The `kubelet` is responsible for watching the `API Server` for all pods that are assigned to the node it is running on. It monitors the state of the pod and directly manages containers running on the host.

#### Kube-Proxy

The `kube-proxy` provides IP networking to a pod. It provides simple round-robin load balancing and routes virtual IPs of Kubernetes services into IPs of backend pods.

## CrateKube


### Platform

These CrateKube platform components provide the ability to create and manage cloud infrastructure and Kubernetes clusters. They are exposed to customers in varying degrees and provide value by abstracting platform operations. All services are expected to live outside the customer cluster unless otherwise specified. Services are expected to be initially deployed through a template in the AWS marketplace. This template will create a temporary cluster for bootstrapping everything, but if technically necessary, a singleton may be created to handle initial provisioning, e.g., using `kind` or a virtual appliance to create provision the components necessary to create the initially infrastructure and cluster.

#### Cloud Management Service

The `cloud-mgmt-service` will be in charge of provisioning and monitoring all cloud resources and services. Cloud resources are loosely defined as managed virtual infrastructure so as to include cluster created on-prem through Openstack or vSphere.

In AWS, this is expected to provision any and all resources necessary to prepare for the creation of a Kubernetes cluster, including but not limited to IAM, VPC, EC2, etc. [Terraform](https://www.terraform.io/) is expected to be used whenever viable. This service will require root access to the user's account with the infrastructure provider. Terraform templates will need to have configuration options that support the compliance rules implemented in the `policy-mgmt-service`. The state files generated by Terraform must be persisted for later use.

#### Cluster Management Service

The `cluster-mgmt-service` will be responsible for the creation, monitoring, and configuration of Kubernetes clusters. It is expected that [RKE](https://rancher.com/docs/rke/latest/en/) will be used by this service to provision clusters. For hosted cluster creation, such as AKS, EKS, or GKE, it is expected that `cluster-mgmt-service` will invoke `cloud-mgmt-service`. Any state files generated by RKE must be persisted for later use.

#### Policy Management Service

The `policy-mgmt-service` will provide a single place to declare security and compliance policies that should be used to configure both cloud and Kubernetes resources. This system is not expected to take action on these settings, as the responsibility for resource configuration lies with other services such as `cloud-mgmt-service` and `cluster-mgmt-service`.

At a later date, this service may also provide the ability to validate that a policy is being followed across the system as well as enforce a policy across the system. Both of these features are not expected to be a part of the MVaP.

#### Lifecycle Service

The `lifecycle-service` will be the primary initiator of all platform services. It will track lifecycle of all platform components and handle service creation, update, and teardown. The service should be able to reconfigure and upgrade itself as needed to be aware of newly created services. It is expected to interact directly with the `cloud-mgmt-service` and the `cluster-mgmt-service` to create cloud resources and Kubernetes clusters.

### Add Ons

These custom services are available for use in any given Kubernetes cluster.

#### Docs

The CrateKube documentation will provide useful information regarding use the system. Eventually, it is expected to provide an interactive terminal for users to try features of the system from within the documentation.

#### Automounts

Automounts will give users the ability to mount NFS storage directly into a container. The solution may be implemented through [autofs](https://www.linuxtechi.com/automount-nfs-share-in-linux-using-autofs/), however, this is an implementation detail that should be considered at time of design.

# MVaP

The MVaP for the CrateKube system is expected to provide the following functionality:

- One-click Kubernetes cluster provisioning to AWS
- Consolidated policy management
- Interactive docs
- Automated NFS storage mounting

To that end, the MVaP should have the ability to instantiate a Kubernetes cluster in AWS using RKE and EC2 instances. All platform services will need to be created. It is expected that the interface to the customer for one-click provisioning will be an AWS marketplace entry that bootstraps the `lifecycle-service`. The `lifecycle-service` would then be responsible for creating all platform components and consequently all customer infrastructure and cluster components.

The default security policies for the MVaP are expected to be in compliance with Cisco's Infosec standards, but the language used to describe the policies will follow NIST conventions. Additionally, clusters created in the MVaP are not expected to use `PodSecurityPolicy` or custom RBAC.

# Diagrams

## Component
![Component](http://www.plantuml.com/plantuml/svg/dPDFIyCm6CRl_HGlyrnMBp9wa66b5_yW3hsK7RBqRGbDav6aao5-TzEbQjQLKCmb6tduFM-U9rrhGvJfMXw1Mtj26r8ZB5uaP_G8JqJOloqA0njK1qPnOLMV4NYhs9-qSLkt9jPEjGMuIf8yJv9VwTU5HyPbLqvP-0O5xLKZUC-sorCvba8jEqLHRoFFTMJxZEP3gWOsHYfIdxj18TnfhDtf09ecFR8AwP5od9mS2lvpxasUvtStsNM8cl5E6rJ1O5moJZZEfi9ojGiwF7GxL08DQXZCHkHc5Gzm__xkPwYNEBwzh09Ie0g9TLkMoB7VcJZ81lKyuFJxIk6TS5RsM62YKcGcRDmlfAU7WDfk5cOfeG8TP3hw7fMzljtFHjW9_m-Ol4bsdhCF6iqS3cMSIHWJBEgl9yYag5Wzb-O_mdJu69Qj5CnE5grHb5tBlm40)
<details><summary>Show UML Code</summary>
<p>

```
@startuml
       package "Policy Management Service"   {
            [policy-mgmt-service]  #00FF00
        }
       package "Cloud Management Service" {
         [cloud-mgmt-service] #00FFFF
         [Cloud resources]
       }
        package "Network Storage" {
          [network-storage]
        }
        package "Lifecycle Service" {
          [lifecycle-service] #FFB6C1
        }
        package "Cluster Management Service" {
          [cluster-mgmt-service] #fed8b1
        }
        package "Kubernetes Cluster" {
          [k8-cluster]
        }

            [cloud-mgmt-service] --> [Cloud resources] : creates/deletes/invokes
            [cloud-mgmt-service] --> [policy-mgmt-service] : Validates infra
            [cloud-mgmt-service] --> [network-storage] : Stores State
            [lifecycle-service] -->  [cluster-mgmt-service] : CRUD
            [lifecycle-service] -->  [cloud-mgmt-service] : CRUD
            [lifecycle-service] -->  [network-storage] : Creates/deletes
            [cluster-mgmt-service] --> [network-storage]: Stores State
            [cluster-mgmt-service] --> [policy-mgmt-service]: Validate Config
            [cluster-mgmt-service] --> [k8-cluster]: Manage/monitor
@enduml
```
</p>
</details>

## Logical
![Component](https://www.plantuml.com/plantuml/svg/fLN1Zfim5Bpp5LPwHabxg5OvLDkbvR9jj6hKzX3buBKVgHLZ8zliQbNnxtt6927Wi6cB5A7WOTwycMTpQnqrhYvbmgIkEPbzpjxDoE-4uAKq1pAxlx7aGL9NQ5EIJDRMWJaWyAeeszCTuXwq5Eo5VAKA_vQW75c3UH8CUk3ssbGjCYrtfKjjm6p9cyKYpnUB8x8P5SXQWQ_mRzesOjnvtaC5BWDMruQ1tIR3ggUoAt3Fskp9scc33ywxsQYmcjgmkXthFp5z4GMm5oOXxin67jPxolFyxdtsTegrY-HLuz6P5ZZqfW1-ynYhSD7EDFqmTf0i2JD07TWv1md-BjIJteEzaZ0w5KloWqh1FIqHgZ3qIh9XB4ZayqEMjKEoSvQ8xvxaacDBadtx_kbgYh72loA8T9AT-poq9AOvQigK9nCqiQ1EEP5CgqBihcQxhn_1AD_7uN11iZ3Byr8hWGgJf3UOtQ4qUcjuoWGSYd56It-0AI0hV3R4zNQI9_rO2RzxndoXaJr2Kbg9jWcK6de0nxWF1dFXysSZ-cOs-1iIdLKadKPvtCDJjTaHd9O1t6aOALlYXa5V2ihw8z9CQrcpNy1hEId11WpzryfD9AUVE9VOVpIWBac3mzLgND4IREN99xBacjcq5hF9zMuIBu9exNIfQ-MYq2RflzUfn5dKfU_a6f57DAsgYoB-2tGoFToI9ha5nV5x_mS0)
<details><summary>Show UML Code</summary>
<p>

```
@startuml
cloud "EC2" {
    node "K8s Platform Cluster" {
       package "Policy Management Service" {
            [policy-mgmt-service] #00FF00
        }
       package "Cloud Management Service" {
         [cloud-mgmt-service] #00FFFF
         [Cloud resources]
       }
        package "Network Storage" {
          [network-storage]
        }
        package "Lifecycle Service" {
          [lifecycle-service] #FFB6C1
        }
        package "Cluster Management Service" {
          [cluster-mgmt-service] #fed8b1
        }
            [cloud-mgmt-service] --> [Cloud resources] : creates/deletes/invokes
            [cloud-mgmt-service] --> [policy-mgmt-service] : Validates infra
            [cloud-mgmt-service] --> [network-storage] : Stores State
            [lifecycle-service] -->  [cluster-mgmt-service] : CRUD
            [lifecycle-service] -->  [cloud-mgmt-service] : CRUD
            [lifecycle-service] -->  [network-storage] : Creates/deletes
            [cluster-mgmt-service] --> [network-storage]: Stores State
            [cluster-mgmt-service] --> [policy-mgmt-service]: Validate Config
            [cluster-mgmt-service] --> [Kubernetes Cluster]: Manage/monitor

    }
     node "Kubernetes Cluster" {
            node "Control Plane Node" {
              package "KubeApiServer" {
                 [kube-api-server] --> [etcd] : read/write
         }   
               package "Kube Controller Manager" {
                 [kube-controller-manager] --> [kube-api-server] : interfaces
         }
               package "Kube Scheduler" {
                 [kube-schedular] --> [kube-api-server] : interfaces
         }
       }
            node "Worker Node" {
             node "CrateKube Namespaces" {
              package "docs-ui"
              package "docs-service"
              package "automounts-service"
          }

           node "Customer Namespaces" {
              package "Customer app"
              package "Customer app"
              package "Customer app"
          }
       }      
}
@enduml


```
</p>
</details>

## Physical
![Component](hhttps://www.plantuml.com/plantuml/svg/VLF1Ri8m3BtdAwpiNAdROTeHLWq98Mr873Y7nB28D8dS50rD_FjIs81LRdrqdjzxUN4cJLAKsje9xK9hGBvLJnA-1LpA1uCWFoAIIZRu1YhNDWdf3j9LL7glTXbv9YdgNPsA1kbWDKfuACjPhW7ycQu_iKNpidba9s9mLXyvYR9a1vpTeZvgXtVmsUprkRhnd_vVT-wtf619uM0DKZDqr-bw9GNFi6WtI1uJye5TG5NmYOA3fLCUuJttUaetgNtcWvN-HDEwp3KCAlI5r7MPAf_xesWLRHVA80YJDYFp3jCOUwJmTPH2i15LUQEmomdMWVP8N01NkWKZncfnvxfJEYUeZ2do4ikUerz3-Pr2dOqC-haoNg7J62K7OCBXx0A8kntySvMx9p51R_Al_040)
<details><summary>Show UML Code</summary>
<p>

```
@startuml
cloud "EC2" {
       node "Operations Cluster" {
           package "cloud-mgmt-service" #00FFFF
           package "cluster-mgmt-service" #fed8b1
           package "policy-mgmt-service" #00FF00
           package "lifecycle-service" #FFB6C1
        }
       node "Infra Providers" {
           package "AWS"
       }
       node "Kubernetes Cluster" {
         node "Control Plane Node" {
            package "kube Scheduler"
            package "kube-controller-manager"
            package "kube-apiserver"
            package "etcd"
            package "kubelet"
            package "kube-proxy"

      }
       node "CrateKube Worker Node" {
           package "Kubelet"
           package "kube-proxy"
           package "cratekube add-ons"
      }
      node "Customer Worker Node" {
          package "Customer App"
          package "kubelet"
          package "kube-proxy"  

        }

      }  
}
@enduml

```
</p>
</details>

## Security

![Component](http://www.plantuml.com/plantuml/svg/ZP9VQy8m5CNV-oc2UoxKbo5zA39166v3s6Cc4fDRpKoJaZ-A4x_xObt0RDCcRpSv-N4uvuwD9TgwHcHICK23sSYWkI2sLhf14-6C1Jr0nmoXbj0jMNl9H2Z7q2kHVcf0MlGEUiSfT39_C3qBycRTsDnSdZxayNDlbyJPpTTfWHwAOkgFLv-kmI-y1dgW0duJ4HRXwHPnEdrwd0op977kshpgTLdYCD15verU1z35SZi2J2-AkndKm4QhOKoUAy7fuGwuxGIzsHP5p7sMjIPehjMEiz0dvkVBlFsvz1ZIye29ly_S2hG42oPQ2VpttbEiCFzJtXI3opzZDiij76ekeDEaTCRKNkPL76rASVth6DWXt5HolvUmQ-daTC_L_G9B78PqgrL_eoK-3-sMfqFZkijkwW2dR0oIkKPy0m00)
<details><summary>Show UML Code</summary>
<p>

```
@startuml
node "K8s Platform Cluster" {
  package "Cloud Management Service" {
    [cloud-mgmt-service\n{jwt_authz}] #00FFFF
  }
  package "Lifecycle Service" {
     [lifecycle-service\n{jwt_authz}] #FFB6C1
    [lifecycle-service\n{jwt_authz}] -up->[cloud-mgmt-service\n{jwt_authz}]:[jwt_authc]
 }
 package "Cluster Management Service" {
   [cluster-mgmt-service\n{jwt_authz}] #fed8b1
 }
 package "Policy Management Service" {
   [policy-mgmt-service\n{jwt_authz}] #00FF00
 }
 package "Infra Provider" {
  [infra-provider\n{api_authz}]
 }
 package "Kubernetes Cluster" {
 [Kubernetes Cluster\n{tls_authz}]
 }
 package "Node" {
 [ssh_keyfile]
 }
  [lifecycle-service\n{jwt_authz}] -down-> [cluster-mgmt-service\n{jwt_authz}]:[jwt_authc]
  [cloud-mgmt-service\n{jwt_authz}] -down->[policy-mgmt-service\n{jwt_authz}]:[jwt_authc]
  [cluster-mgmt-service\n{jwt_authz}] -up->[policy-mgmt-service\n{jwt_authz}]:[jwt_authc]
  [cloud-mgmt-service\n{jwt_authz}] -> [infra-provider\n{api_authz}]:[api_authc]
  [cluster-mgmt-service\n{jwt_authz}] -> [Kubernetes Cluster\n{tls_authz}]:[tls_pki]
  [cluster-mgmt-service\n{jwt_authz}] -> [ssh_keyfile]:[ssh_pki]
}
@enduml
```
</p>
</details>
